{{/*
    Copyright Â© 2024 - 2026 The Hinode Team / Mark Dumay. All rights reserved.
    Use of this source code is governed by The MIT License (MIT) that can be found in the LICENSE file.
    Visit gethinode.com/license for more details.
*/}}

{{ $error := false }}

{{/* Initialize arguments */}}
{{ $args := partial "utilities/InitArgs.html" (dict "structure" "icon" "args" . "group" "partial")}}
{{ if or $args.err $args.warnmsg }}
    {{ partial (cond $args.err "utilities/LogErr.html" "utilities/LogWarn.html") (dict
        "partial" "assets/icon.html"
        "warnid"  "warn-invalid-arguments"
        "msg"     "Invalid arguments"
        "details" ($args.errmsg | append $args.warnmsg)
        "file"    page.File
    )}}
    {{ $error = $args.err }}
{{ end }}

{{- $icon := string $args.icon -}}
{{- $src := $args.src -}}

{{- if and (not $icon) (not $src) -}}
    {{ errorf "partial [assets/icon.html] - Missing value for param 'icon' or 'src'" }}
{{- end -}}

{{- $wrapper := $args.wrapper -}}
{{- if $wrapper -}}
    {{/* Handle fa-wrapper special case only when it's the exact value */}}
    {{- if eq $wrapper "fa-wrapper" -}}
        {{- $wrapper = cond (in $args.class "fa-fluid") "w-100" "" -}}
    {{- end -}}
{{- end -}}

{{- $style := or $args.inlineStyle $args.style -}}
{{- $output := "" -}}

{{/* Generate deprecation warnings for global config - always warn if old parameters present */}}
{{- $deprecationWarnings := slice -}}
{{- if isset site.Params.modules.fontawesome "inline" -}}
    {{- $deprecationWarnings = $deprecationWarnings | append "Configuration parameter 'inline' is deprecated in Hinode v2.0.0, remove it and use 'mode' instead" -}}
{{- end -}}
{{- if isset site.Params.modules.fontawesome "embed" -}}
    {{- $deprecationWarnings = $deprecationWarnings | append "Configuration parameter 'embed' is deprecated in Hinode v2.0.0, remove it and use 'mode' instead" -}}
{{- end -}}

{{/* Output deprecation warnings - use warnf for visibility in terminal */}}
{{- if $deprecationWarnings -}}
    {{- range $deprecationWarnings -}}
        {{- warnf "[mod-fontawesome] %s" . -}}
    {{- end -}}
{{- end -}}

{{/* Determine rendering mode from global config */}}
{{- $mode := site.Params.modules.fontawesome.mode -}}
{{- if not $mode -}}
    {{/* Fallback to legacy inline/embed if mode not set in config */}}
    {{- $inline := default true site.Params.modules.fontawesome.inline -}}
    {{- $embed := default true site.Params.modules.fontawesome.embed -}}

    {{/* Map old parameters to new mode */}}
    {{- if not $inline -}}
        {{- $mode = "webfonts" -}}
    {{- else if not $embed -}}
        {{- $mode = "svg" -}}
    {{- else -}}
        {{- $mode = "symbols" -}}
    {{- end -}}
{{- else -}}
    {{/* Validate mode parameter - must be one of: symbols, svg, webfonts */}}
    {{- $validModes := slice "symbols" "svg" "webfonts" -}}
    {{- if not (in $validModes $mode) -}}
        {{- warnf "[mod-fontawesome] Invalid mode '%s'. Valid values are: symbols, svg, webfonts. Defaulting to 'symbols'." $mode -}}
        {{- $mode = "symbols" -}}
    {{- end -}}
{{- end -}}

{{- if not $error }}
    {{- if $style }}
        {{- $style = printf " style=\"%s\"" $style }}
    {{- end -}}

    {{- $family := "" -}}
    {{- $name := "" -}}
    {{- $attr := "" -}}
    {{- $isFontAwesome := false -}}

    {{- if $src -}}
        {{/* Custom SVG from file - always load as static resource */}}
        {{- $attr = default "" $icon -}}
        {{- $family = "src" -}}
        {{- $name = path.BaseName $src -}}
        {{- $svg := resources.Get $src -}}
        {{- if $svg -}}
            {{- $regex := printf `%s((?:.|\\n)*)%s` "<!--" "-->" -}}
            {{- $content := (replaceRE $regex "" $svg.Content) -}}
            {{/* Strip XML declaration if present */}}
            {{- $content = replaceRE `<\?xml[^>]*\?>` "" $content -}}
            {{- $content = replaceRE `^\s+` "" $content -}}
            {{- $inject := (replaceRE "xmlns=\\\"(.*?)\\\"" (printf "class=\"svg-inline--fa %s\" fill=\"currentColor\" aria-hidden=\"true\" role=\"img\"%s" $attr (or $style "")) $content) -}}
            {{/* Remove fixed width/height to allow CSS sizing (fa-2x, fa-3x, fa-4x, etc.) */}}
            {{- $inject = replaceRE "width=\\\"(.*?)\\\"" "" $inject -}}
            {{- $inject = replaceRE "height=\\\"(.*?)\\\"" "" $inject -}}
            {{- $output = $inject -}}

            {{/* Handle symbols mode - convert to symbol reference */}}
            {{- if and (eq $mode "symbols") (page) -}}
                {{- $symbolId := printf "%s-%s" $family $name -}}
                {{- $definition := index (findRE "<svg[^>]*>" $output 1) 0 -}}
                {{/* Add overflow="visible" attribute to containing SVG */}}
                {{- $definition = replaceRE "(<svg[^>]*)" "${1} overflow=\"visible\"" $definition -}}
                {{- $output = printf `%s<use href="#%s"></use></svg>` $definition $symbolId -}}

                {{/* Create symbol definition with overflow attribute */}}
                {{/* First extract viewBox for symbol */}}
                {{- $viewBox := "" -}}
                {{- with (findRE `viewBox="[^"]*"` $content 1) -}}
                    {{- $viewBox = index . 0 -}}
                {{- end -}}
                {{/* Extract path content between svg tags */}}
                {{- $pathContent := replaceRE `^<svg[^>]*>` "" $content -}}
                {{- $pathContent = replaceRE `</svg>\s*$` "" $pathContent -}}
                {{/* Build clean symbol */}}
                {{- $entry := printf `<symbol id="%s" overflow="visible" %s>%s</symbol>` $symbolId $viewBox $pathContent -}}
                {{- page.Scratch.Add "icons" (slice $entry) -}}
            {{- end -}}
        {{- end -}}
    {{- else -}}
        {{/* Parse icon family and name */}}
        {{- $icon_class := split $icon " " -}}
        {{- $tokenCount := len $icon_class -}}

        {{/* Apply default family if no family prefix provided */}}
        {{- if eq $tokenCount 1 -}}
            {{/* Single token means icon name only, prepend default family */}}
            {{- $defaultFamily := site.Params.modules.fontawesome.defaultFamily | default "fas" -}}
            {{- $icon = printf "%s %s" $defaultFamily $icon -}}
            {{- $icon_class = split $icon " " -}}

            {{/* Optional debug output */}}
            {{- if site.Params.modules.fontawesome.debug -}}
                {{- warnf "[mod-fontawesome] Applied default family '%s' to icon '%s'" $defaultFamily $icon -}}
            {{- end -}}
        {{- end -}}

        {{- $family = (index $icon_class 0) -}}
        {{- $attr = trim (printf "%s %s" (delimit (after 2 $icon_class) " ") ($args.class | default "")) " " -}}

        {{/* Normalize and check FontAwesome families */}}
        {{- $family = replace $family "fa-solid" "fas" -}}
        {{- $family = replace $family "fa-regular" "far" -}}
        {{- $family = replace $family "fa-brands" "fab" -}}
        {{- $supportedFAFamilies := slice "fas" "far" "fa" "fab" -}}
        {{- $isFontAwesome = in $supportedFAFamilies $family -}}

        {{- if $isFontAwesome -}}
            {{/* FontAwesome icon rendering */}}
            {{- $name = index $icon_class 1 -}}
            {{- $name = strings.TrimPrefix "fa-" $name -}}

            {{- if eq $mode "symbols" -}}
                {{/* SVG symbols mode - load static SVG */}}
                {{/* All icons use symbol references with overflow="visible" to prevent clipping */}}
                {{- $faFamily := cond (eq $family "fas") "solid" (cond (eq $family "far") "regular" (cond (eq $family "fab") "brands" "solid")) -}}
                {{- $path := printf "svgs/fa/%s/%s.svg" $faFamily $name -}}
                {{- $svg := resources.Get $path -}}
                {{- if not $svg -}}
                    {{- $msg := printf "partial [assets/icon.html] - Cannot find FontAwesome icon: %s" (path.Join "assets" $path) -}}
                    {{- if site.Params.modules.fontawesome.skipMissing -}}
                        {{- warnf $msg -}}
                        {{/* Fallback to webfont icon class */}}
                        {{- $output = printf "<i class=\"%s fa-%s %s\"%s></i>" $family $name $attr (or $style "") -}}
                    {{- else -}}
                        {{- errorf $msg -}}
                    {{- end -}}
                {{- else -}}
                    {{/* Process SVG content */}}
                    {{- $regex := printf `%s((?:.|\\n)*)%s` "<!--" "-->" -}}
                    {{- $content := (replaceRE $regex "" $svg.Content) -}}
                    {{/* Strip XML declaration if present */}}
                    {{- $content = replaceRE `<\?xml[^>]*\?>` "" $content -}}
                    {{- $content = replaceRE `^\s+` "" $content -}}
                    {{- $inject := (replaceRE "xmlns=\\\"(.*?)\\\"" (printf "class=\"svg-inline--fa %s fa-%s %s\" fill=\"currentColor\" aria-hidden=\"true\" role=\"img\"%s" $family $name $attr (or $style "")) $content) -}}
                    {{/* Remove fixed width/height to allow CSS sizing (fa-2x, fa-3x, etc.) */}}
                    {{- $inject = replaceRE "width=\\\"(.*?)\\\"" "" $inject -}}
                    {{- $inject = replaceRE "height=\\\"(.*?)\\\"" "" $inject -}}

                    {{- if page -}}
                        {{/* Static icons: create symbol reference with viewBox and overflow */}}
                        {{/* Per FontAwesome docs: add overflow="visible" to prevent clipping */}}
                        {{- $symbolId := printf "%s-%s" $family $name -}}
                        {{- $definition := index (findRE "<svg[^>]*>" $inject 1) 0 -}}
                        {{/* Add overflow="visible" attribute to containing SVG */}}
                        {{- $definition = replaceRE "(<svg[^>]*)" "${1} overflow=\"visible\"" $definition -}}
                        {{- $output = printf `%s<use href="#%s"></use></svg>` $definition $symbolId -}}

                        {{/* Create symbol definition with viewBox and overflow attribute */}}
                        {{/* Per FontAwesome docs: symbols need viewBox + overflow="visible" to prevent clipping */}}
                        {{/* First extract viewBox for symbol */}}
                        {{- $viewBox := "" -}}
                        {{- with (findRE `viewBox="[^"]*"` $content 1) -}}
                            {{- $viewBox = index . 0 -}}
                        {{- end -}}
                        {{/* Extract path content between svg tags */}}
                        {{- $pathContent := replaceRE `^<svg[^>]*>` "" $content -}}
                        {{- $pathContent = replaceRE `</svg>\s*$` "" $pathContent -}}
                        {{/* Build clean symbol */}}
                        {{- $entry := printf `<symbol id="%s" overflow="visible" %s>%s</symbol>` $symbolId $viewBox $pathContent -}}
                        {{- page.Scratch.Add "icons" (slice $entry) -}}
                    {{- else -}}
                        {{/* Fallback to inline SVG if no page context */}}
                        {{- $output = $inject -}}
                    {{- end -}}
                {{- end -}}
            {{- else if eq $mode "svg" -}}
                {{/* Build-time inline SVG mode - load static SVG, no JS required */}}
                {{- $faFamily := cond (eq $family "fas") "solid" (cond (eq $family "far") "regular" (cond (eq $family "fab") "brands" "solid")) -}}
                {{- $path := printf "svgs/fa/%s/%s.svg" $faFamily $name -}}
                {{- $svg := resources.Get $path -}}
                {{- if not $svg -}}
                    {{- $msg := printf "partial [assets/icon.html] - Cannot find FontAwesome icon: %s" (path.Join "assets" $path) -}}
                    {{- if site.Params.modules.fontawesome.skipMissing -}}
                        {{- warnf $msg -}}
                        {{/* Fallback to webfont icon class */}}
                        {{- $output = printf "<i class=\"%s fa-%s %s\"%s></i>" $family $name $attr (or $style "") -}}
                    {{- else -}}
                        {{- errorf $msg -}}
                    {{- end -}}
                {{- else -}}
                    {{/* Process SVG content */}}
                    {{- $regex := printf `%s((?:.|\\n)*)%s` "<!--" "-->" -}}
                    {{- $content := (replaceRE $regex "" $svg.Content) -}}
                    {{/* Strip XML declaration if present */}}
                    {{- $content = replaceRE `<\?xml[^>]*\?>` "" $content -}}
                    {{- $content = replaceRE `^\s+` "" $content -}}
                    {{- $inject := (replaceRE "xmlns=\\\"(.*?)\\\"" (printf "class=\"svg-inline--fa %s fa-%s %s\" fill=\"currentColor\" aria-hidden=\"true\" role=\"img\"%s" $family $name $attr (or $style "")) $content) -}}
                    {{/* Remove fixed width/height to allow CSS sizing (fa-2x, fa-3x, etc.) */}}
                    {{- $inject = replaceRE "width=\\\"(.*?)\\\"" "" $inject -}}
                    {{- $inject = replaceRE "height=\\\"(.*?)\\\"" "" $inject -}}
                    {{/* Add overflow="visible" to prevent clipping of FA v7 paths with negative coordinates */}}
                    {{- $inject = replaceRE "(<svg[^>]*)" "${1} overflow=\"visible\"" $inject -}}
                    {{- $output = $inject -}}
                {{- end -}}
            {{- else -}}
                {{/* Webfont mode - <i> tag rendered via CSS @font-face */}}
                {{- $output = printf "<i class=\"%s fa-%s %s\"%s></i>" $family $name $attr (or $style "") -}}
            {{- end -}}
        {{- else -}}
            {{/* Other icon families (Bootstrap Icons, Material Design Icons, etc.) */}}
            {{- $name = index $icon_class 1 -}}

            {{- if ne $mode "webfonts" -}}
                {{/* SVG mode - load static SVG for non-FontAwesome icons */}}
                {{- $path := printf "svgs/%s/%s.svg" $family $name -}}
                {{- $svg := resources.Get $path -}}
                {{- if not $svg -}}
                    {{- $msg := printf "partial [assets/icon.html] - Cannot find icon: %s" (path.Join "assets" $path) -}}
                    {{- if site.Params.modules.fontawesome.skipMissing -}}
                        {{- warnf $msg -}}
                        {{/* Fallback to webfont icon class */}}
                        {{- $output = printf "<i class=\"%s %s-%s %s\"%s></i>" $family $family $name $attr (or $style "") -}}
                    {{- else -}}
                        {{- errorf $msg -}}
                    {{- end -}}
                {{- else -}}
                    {{/* Process SVG content */}}
                    {{- $regex := printf `%s((?:.|\\n)*)%s` "<!--" "-->" -}}
                    {{- $content := (replaceRE $regex "" $svg.Content) -}}
                    {{/* Strip XML declaration if present */}}
                    {{- $content = replaceRE `<\?xml[^>]*\?>` "" $content -}}
                    {{- $content = replaceRE `^\s+` "" $content -}}
                    {{/* Clean up original SVG attributes to prevent duplicates */}}
                    {{- $content = replaceRE "xmlns=\\\"(.*?)\\\"" "" $content -}}
                    {{- $content = replaceRE "class=\\\"(.*?)\\\"" "" $content -}}
                    {{- $content = replaceRE "fill=\\\"(.*?)\\\"" "" $content -}}
                    {{- $content = replaceRE "width=\\\"(.*?)\\\"" "" $content -}}
                    {{- $content = replaceRE "height=\\\"(.*?)\\\"" "" $content -}}
                    {{/* Remove id attribute to prevent duplicate IDs (e.g. id="Outline" in Flaticon SVGs) */}}
                    {{- $content = replaceRE " id=\\\"(.*?)\\\"" "" $content -}}
                    {{/* Inject our clean attributes */}}
                    {{- $inject := (replaceRE "^<svg " (printf "<svg class=\"svg-inline--fa %s %s-%s %s\" fill=\"currentColor\" aria-hidden=\"true\" role=\"img\"%s " $family $family $name $attr (or $style "")) $content) -}}
                    {{- $output = $inject -}}

                    {{/* Handle symbols mode - convert to symbol reference */}}
                    {{- if and (eq $mode "symbols") (page) -}}
                        {{- $symbolId := printf "%s-%s" $family $name -}}
                        {{- $definition := index (findRE "<svg[^>]*>" $output 1) 0 -}}
                        {{/* Add overflow="visible" attribute to containing SVG */}}
                        {{- $definition = replaceRE "(<svg[^>]*)" "${1} overflow=\"visible\"" $definition -}}
                        {{- $output = printf `%s<use href="#%s"></use></svg>` $definition $symbolId -}}

                        {{/* Create symbol definition with overflow attribute */}}
                        {{/* First extract viewBox for symbol */}}
                        {{- $viewBox := "" -}}
                        {{- with (findRE `viewBox="[^"]*"` $content 1) -}}
                            {{- $viewBox = index . 0 -}}
                        {{- end -}}
                        {{/* Extract path content between svg tags */}}
                        {{- $pathContent := replaceRE `^<svg[^>]*>` "" $content -}}
                        {{- $pathContent = replaceRE `</svg>\s*$` "" $pathContent -}}
                        {{/* Build clean symbol */}}
                        {{- $entry := printf `<symbol id="%s" overflow="visible" %s>%s</symbol>` $symbolId $viewBox $pathContent -}}
                        {{- page.Scratch.Add "icons" (slice $entry) -}}
                    {{- end -}}
                {{- end -}}
            {{- else -}}
                {{/* Webfont mode - output simple <i> tag for CSS to handle */}}
                {{- $output = printf "<i class=\"%s %s-%s %s\"%s></i>" $family $family $name $attr (or $style "") -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}

    {{- if and site.Params.modules.fontawesome.debug $isFontAwesome -}}
        {{- printf "<!-- FontAwesome: %s -->" $output | safeHTML }}
    {{ end -}}

    {{- with $wrapper -}}
        <div class="{{ . }}">{{ $output | safeHTML }}</div>
    {{- else -}}
        {{- $output | safeHTML -}}
    {{- end -}}
    {{/* Don't add spacing for stacked icons (fa-stack-1x or fa-stack-2x) */}}
    {{- $isStackedIcon := or (in $args.icon "fa-stack-1x") (in $args.icon "fa-stack-2x") -}}
    {{- if and $args.spacing (not $isStackedIcon) }}&nbsp;{{- end -}}
{{- end -}}
